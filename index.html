<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="MindUrMind - School wellbeing awareness and habit building (non-clinical, privacy-first, on-device)." />
  <title>MindUrMind</title>

  <style>
    :root{
      --bg0:#f7fbff; --bg1:#f3fff8; --bg2:#fff7fb;
      --card:#ffffffcc; --border: rgba(24,55,90,.10);
      --text:#10213a; --muted: rgba(16,33,58,.72); --muted2: rgba(16,33,58,.58);
      --accent:#3bb9ff; --accent2:#41d7a0; --warn:#ffb454; --danger:#ff5a76;
      --shadow: 0 18px 50px rgba(14,38,76,.10); --shadow2: 0 10px 25px rgba(14,38,76,.08);
      --radius: 20px; --focus: 0 0 0 4px rgba(59,185,255,.22);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --t-fast: 140ms; --t-med: 220ms; --t-slow: 420ms;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: var(--sans); color:var(--text);
      background:
        radial-gradient(900px 520px at 12% 12%, rgba(59,185,255,.14), transparent 55%),
        radial-gradient(850px 540px at 88% 18%, rgba(65,215,160,.14), transparent 58%),
        radial-gradient(920px 560px at 50% 105%, rgba(255,180,84,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 55%, var(--bg2));
      overflow-x:hidden;
    }
    a{color:inherit}
    .blob{position:fixed;z-index:-1;filter:blur(2px);opacity:.55;border-radius:999px;pointer-events:none;transform:translateZ(0)}
    .blob.one{width:360px;height:360px;left:-90px;top:120px;background:radial-gradient(circle at 30% 30%, rgba(59,185,255,.42), rgba(59,185,255,0))}
    .blob.two{width:420px;height:420px;right:-140px;top:90px;background:radial-gradient(circle at 30% 30%, rgba(65,215,160,.42), rgba(65,215,160,0))}
    .blob.three{width:520px;height:520px;left:28%;bottom:-220px;background:radial-gradient(circle at 30% 30%, rgba(255,180,84,.32), rgba(255,180,84,0))}

    .wrap{min-height:100%;display:flex;flex-direction:column}
    .topbar{position:sticky;top:0;z-index:10;backdrop-filter:blur(12px);background:rgba(255,255,255,.72);border-bottom:1px solid var(--border)}
    .topbar-inner{max-width:1100px;margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    .logo{
      width:38px;height:38px;border-radius:14px;
      background:
        radial-gradient(20px 18px at 30% 30%, rgba(255,255,255,.75), transparent 60%),
        linear-gradient(135deg, rgba(59,185,255,.85), rgba(65,215,160,.75));
      box-shadow:0 12px 26px rgba(14,38,76,.12);
      position:relative;overflow:hidden
    }
    .logo:after{
      content:"";position:absolute;inset:-20%;
      background:linear-gradient(110deg, transparent, rgba(255,255,255,.55), transparent);
      transform:rotate(12deg) translateX(-80%);
      animation:sheen 6s ease-in-out infinite;opacity:.55
    }
    @keyframes sheen{
      0%,55%{transform:rotate(12deg) translateX(-90%);opacity:0}
      70%{opacity:.55}
      100%{transform:rotate(12deg) translateX(110%);opacity:0}
    }
    .brand h1{font-size:16px;margin:0;letter-spacing:.2px;font-weight:800}
    .brand small{display:block;font-size:12px;color:var(--muted2);margin-top:1px;font-weight:650}
    .top-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      font-size:12px;color:var(--muted);
      border:1px solid var(--border);
      background:rgba(255,255,255,.70);
      padding:8px 10px;border-radius:999px;
      display:inline-flex;align-items:center;gap:8px;user-select:none;
      box-shadow:var(--shadow2)
    }
    .chip strong{color:var(--text);font-weight:850}
    .btn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.80);
      color:var(--text);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;font-weight:800;font-size:13px;
      transition:transform var(--t-fast) ease, background var(--t-med) ease, border-color var(--t-med) ease, box-shadow var(--t-med) ease;
      box-shadow:var(--shadow2)
    }
    .btn:hover{background:rgba(255,255,255,.92);border-color:rgba(24,55,90,.18);box-shadow:0 12px 25px rgba(14,38,76,.12);transform:translateY(-1px)}
    .btn:active{transform:translateY(0) scale(.99)}
    .btn.primary{border-color:rgba(59,185,255,.30);background:linear-gradient(135deg, rgba(59,185,255,.18), rgba(65,215,160,.14))}
    .btn.danger{border-color:rgba(255,90,118,.35);background:rgba(255,90,118,.09)}
    .btn:focus{outline:none;box-shadow:var(--focus)}
    .smallbtn{padding:8px 10px;border-radius:12px;font-size:12px;font-weight:900}

    main{max-width:1100px;width:100%;margin:0 auto;padding:22px 18px 28px;flex:1}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;align-items:start}
    @media (max-width:920px){.grid{grid-template-columns:1fr}}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
      transform:translateZ(0);
      animation:popin var(--t-slow) ease both
    }
    @keyframes popin{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    .card-header{
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(16,33,58,.08);
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.55))
    }
    .card-header h2{margin:0;font-size:16px;letter-spacing:.2px}
    .card-header p{margin:6px 0 0;font-size:13px;color:var(--muted);line-height:1.4;max-width:64ch}
    .card-body{padding:16px}

    .stack{display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:7px;min-width:220px;flex:1}
    label{font-size:12px;color:var(--muted2);font-weight:800;letter-spacing:.2px}
    input,select,textarea{
      width:100%;padding:12px 12px;border-radius:14px;
      border:1px solid rgba(24,55,90,.14);
      background:rgba(255,255,255,.82);
      color:var(--text);font-size:14px;outline:none;
      box-shadow:var(--shadow2);
      transition:box-shadow var(--t-med) ease, border-color var(--t-med) ease, transform var(--t-fast) ease
    }
    textarea{min-height:96px;resize:vertical}
    input:focus,select:focus,textarea:focus{box-shadow:var(--focus), var(--shadow2);border-color:rgba(59,185,255,.34)}
    input:hover,select:hover,textarea:hover{border-color:rgba(24,55,90,.18)}
    .help{font-size:12px;color:var(--muted2);line-height:1.35}

    .note{
      padding:12px 12px;border-radius:16px;
      border:1px solid rgba(24,55,90,.12);
      background:rgba(255,255,255,.78);
      color:var(--muted);font-size:13px;line-height:1.45;
      box-shadow:var(--shadow2)
    }
    .note strong{color:var(--text)}
    .note.warn{border-color:rgba(255,180,84,.30);background:rgba(255,180,84,.12)}
    .note.ok{border-color:rgba(65,215,160,.30);background:rgba(65,215,160,.10)}
    .divider{height:1px;background:rgba(24,55,90,.10);margin:8px 0}

    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:9px 10px;border-radius:14px;
      border:1px solid rgba(24,55,90,.12);
      background:rgba(255,255,255,.70);
      color:var(--muted);
      cursor:pointer;font-weight:900;font-size:13px;
      box-shadow:var(--shadow2);
      transition:transform var(--t-fast) ease, background var(--t-med) ease, border-color var(--t-med) ease
    }
    .tab:hover{transform:translateY(-1px);background:rgba(255,255,255,.90);border-color:rgba(24,55,90,.18)}
    .tab.active{color:var(--text);border-color:rgba(59,185,255,.32);background:linear-gradient(135deg, rgba(59,185,255,.14), rgba(65,215,160,.12))}

    .pillrow{display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      border:1px solid rgba(24,55,90,.12);
      background:rgba(255,255,255,.78);
      border-radius:999px;
      padding:8px 10px;font-size:12px;color:var(--muted);
      display:inline-flex;align-items:center;gap:8px;
      box-shadow:var(--shadow2)
    }
    .pill b{color:var(--text)}

    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:520px){.kpi{grid-template-columns:1fr}}
    .kpi .box{
      background:rgba(255,255,255,.78);
      border:1px solid rgba(24,55,90,.10);
      border-radius:18px;
      padding:12px 12px;
      box-shadow:var(--shadow2)
    }
    .kpi .box .v{font-size:18px;font-weight:950;letter-spacing:.2px;margin-top:4px}
    .kpi .box .t{font-size:12px;color:var(--muted2);font-weight:900;letter-spacing:.15px}

    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(24,55,90,.10);
      background:rgba(255,255,255,.78);
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow2);
      transition:transform var(--t-fast) ease, box-shadow var(--t-med) ease
    }
    .item:hover{transform:translateY(-1px);box-shadow:0 14px 28px rgba(14,38,76,.10)}
    .item h3{margin:0 0 6px;font-size:14px}
    .item p{margin:0;color:var(--muted);font-size:13px;line-height:1.45}
    .muted{color:var(--muted2)}
    .right-col .card{box-shadow:none}

    footer{max-width:1100px;margin:0 auto;padding:0 18px 18px;color:var(--muted2);font-size:12px;line-height:1.4}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(59,185,255,.28);
      background:rgba(59,185,255,.12);
      color:var(--text);
      font-weight:950;font-size:12px;
      box-shadow:var(--shadow2)
    }
    .dangertext{color:var(--danger)}
    .oktext{color:#12a66b}
    .warntext{color:#d47d00}
    .mono{font-family:var(--mono)}

    .quickgrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    @media(max-width:980px){.quickgrid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:720px){.quickgrid{grid-template-columns:1fr}}

    .tile{
      text-align:left;
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(24,55,90,.10);
      background:rgba(255,255,255,.80);
      cursor:pointer;
      transition:transform var(--t-fast) ease, background var(--t-med) ease, border-color var(--t-med) ease, box-shadow var(--t-med) ease;
      box-shadow:var(--shadow2);
      position:relative;overflow:hidden
    }
    .tile:before{
      content:"";
      position:absolute;inset:-40%;
      background:radial-gradient(circle at 30% 30%, rgba(59,185,255,.14), transparent 55%);
      transform:rotate(8deg);
      opacity:.8;
      pointer-events:none
    }
    .tile:hover{background:rgba(255,255,255,.92);border-color:rgba(24,55,90,.16);transform:translateY(-1px);box-shadow:0 14px 28px rgba(14,38,76,.12)}
    .tile:active{transform:translateY(0) scale(.99)}
    .tile:focus{outline:none;box-shadow:var(--focus)}
    .tile .t{font-weight:950;letter-spacing:.2px;margin:0 0 6px;font-size:14px;position:relative}
    .tile .s{margin:0;color:var(--muted);font-size:13px;line-height:1.35;position:relative}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(255,255,255,.92);
      border:1px solid rgba(24,55,90,.12);
      border-radius:999px;
      padding:10px 12px;
      box-shadow:0 18px 45px rgba(14,38,76,.14);
      color:var(--text);
      font-weight:900;font-size:13px;
      display:none;z-index:99
    }
    .toast.show{display:inline-flex;animation:toastIn var(--t-slow) ease both}
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

    /* Mini-game canvas */
    .gameWrap{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(24,55,90,.10);
      background:linear-gradient(180deg, rgba(59,185,255,.12), rgba(65,215,160,.10));
      box-shadow:var(--shadow2);
      min-height:280px
    }
    canvas{display:block;width:100%;height:320px}
    .gameHUD{
      position:absolute;inset:12px 12px auto 12px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      pointer-events:none
    }
    .hudPill{
      pointer-events:none;
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border-radius:999px;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(24,55,90,.12);
      box-shadow:var(--shadow2);
      font-weight:950;font-size:12px;color:var(--text)
    }

    /* Emotion Quest */
    .questBox{
      border-radius:18px;
      border:1px solid rgba(24,55,90,.10);
      background:rgba(255,255,255,.78);
      box-shadow:var(--shadow2);
      padding:12px;
      overflow:hidden;
    }
    .questProgress{
      height:10px;border-radius:999px;background:rgba(24,55,90,.08);overflow:hidden;border:1px solid rgba(24,55,90,.08)
    }
    .questProgress > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(59,185,255,.55), rgba(65,215,160,.55));
      border-radius:999px;
      transition:width var(--t-med) ease;
    }
    .choiceBtn{
      width:100%;
      text-align:left;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(24,55,90,.10);
      background:rgba(255,255,255,.86);
      box-shadow:var(--shadow2);
      cursor:pointer;
      font-weight:900;
      transition:transform var(--t-fast) ease, box-shadow var(--t-med) ease, border-color var(--t-med) ease;
    }
    .choiceBtn:hover{transform:translateY(-1px);border-color:rgba(24,55,90,.16);box-shadow:0 14px 28px rgba(14,38,76,.10)}
    .choiceBtn:active{transform:translateY(0) scale(.99)}
    .choiceBtn:focus{outline:none;box-shadow:var(--focus)}
    .choiceBtn small{display:block;margin-top:6px;color:var(--muted);font-weight:800}

    /* Coach chat */
    .chatWrap{
      border-radius:18px;
      border:1px solid rgba(24,55,90,.10);
      background:rgba(255,255,255,.78);
      box-shadow:var(--shadow2);
      padding:12px;
    }
    .chatLog{
      max-height:260px;
      overflow:auto;
      padding:6px;
      border-radius:16px;
      border:1px solid rgba(24,55,90,.08);
      background:rgba(255,255,255,.70);
    }
    .msg{display:flex;flex-direction:column;gap:4px;margin:10px 0}
    .msg .who{font-size:12px;color:var(--muted2);font-weight:900}
    .bubble{
      display:inline-block;
      max-width: 80ch;
      padding:10px 12px;
      border-radius:16px;
      border:1px solid rgba(24,55,90,.10);
      background:rgba(255,255,255,.90);
      box-shadow:var(--shadow2);
      line-height:1.45;
      font-size:13px;
      color:rgba(16,33,58,.92);
    }
    .bubble.user{
      background:linear-gradient(135deg, rgba(59,185,255,.16), rgba(65,215,160,.12));
      border-color: rgba(59,185,255,.22);
    }

    @media (prefers-reduced-motion: reduce){
      *{animation-duration:1ms !important;animation-iteration-count:1 !important;transition-duration:1ms !important}
      .logo:after{display:none}
    }
  </style>
</head>

<body>
  <div class="blob one"></div>
  <div class="blob two"></div>
  <div class="blob three"></div>
  <div class="toast" id="toast">Saved ‚úì</div>

  <div class="wrap">
    <header class="topbar" role="banner">
      <div class="topbar-inner">
        <a class="brand" href="#" id="brandHome" aria-label="MindUrMind Home">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>MindUrMind</h1>
            <small>School wellbeing awareness ‚Ä¢ privacy-first ‚Ä¢ on-device</small>
          </div>
        </a>
        <div class="top-actions">
          <span class="chip" title="Pilot design"><span aria-hidden="true">üîí</span><span><strong>Device-only</strong> reflections</span></span>
          <button class="btn smallbtn" id="openFamily">Family Corner</button>
          <button class="btn smallbtn" id="openAbout">About & Privacy</button>
          <button class="btn danger smallbtn" id="logoutBtn" style="display:none">Log out</button>
        </div>
      </div>
    </header>

    <main role="main">
      <div class="grid">
        <section class="card" id="leftCard">
          <div class="card-header">
            <div>
              <h2 id="pageTitle">Sign in</h2>
              <p id="pageSubtitle">Choose your role. This pilot is non-clinical and designed for wellbeing awareness, positive habits, and self-learning.</p>
            </div>
            <div id="roleBadgeWrap" style="display:none">
              <span class="badge" id="roleBadge">Role</span>
            </div>
          </div>
          <div class="card-body" id="mainBody"></div>
        </section>

        <aside class="right-col">
          <section class="card">
            <div class="card-header">
              <div>
                <h2>Quick clarity</h2>
                <p>What this pilot does (and doesn‚Äôt) do ‚Äî in plain language.</p>
              </div>
            </div>
            <div class="card-body">
              <div class="stack">
                <div class="note ok">
                  <strong>What MindUrMind is</strong><br>
                  A school wellbeing awareness and self-learning initiative: emotional literacy, positive habits, and reflection prompts.
                </div>
                <div class="note warn">
                  <strong>What it is not</strong><br>
                  No clinical assessment, diagnosis, therapy, or risk scoring. Not a substitute for professional support.
                </div>
                <div class="note">
                  <strong>Where data lives</strong><br>
                  Student reflections are stored on this device only. School insights (if viewed) are aggregated locally from participating students on the same device ‚Äî no cloud upload.
                </div>
                <div class="divider"></div>
                <div class="help">If you ever feel unsafe or in immediate danger, contact local emergency services or a trusted adult right away.</div>
              </div>
            </div>
          </section>
        </aside>
      </div>
    </main>

    <footer role="contentinfo">
      <div><span class="mono">MindUrMind Pilot</span> ‚Ä¢ Built for school wellbeing awareness ‚Ä¢ Device-only reflections ‚Ä¢ Local-only aggregation for school view</div>
    </footer>
  </div>

<script>
(function(){
  "use strict";

  const NS = "mindurmind_v5_coach_emotionquest";
  const K = {
    SESSION: `${NS}:session`,
    STUDENTS: `${NS}:students`,
    CHECKINS: `${NS}:checkins`,
    HABITS: `${NS}:habits`,
    SETTINGS: `${NS}:settings`,
    ECOACTIONS: `${NS}:ecoactions`,
    COACHCHAT: `${NS}:coachchat`,         // map studentId -> array messages
    QUEST: `${NS}:quest`                  // map studentId -> quest progress
  };

  function nowISO(){ return new Date().toISOString(); }
  function todayKey(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const da = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${da}`;
  }
  function loadJSON(key, fallback){
    try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
    catch(e){ console.warn("loadJSON failed", key, e); return fallback; }
  }
  function saveJSON(key, value){
    try{ localStorage.setItem(key, JSON.stringify(value)); return true; }
    catch(e){ console.error("saveJSON failed", key, e); return false; }
  }
  function escapeHTML(str){
    return String(str).replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[c]));
  }
  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function uid(){ return "u_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36); }
  function fmtDateShort(iso){
    try{ const d = new Date(iso); return d.toLocaleDateString(undefined, {weekday:"short", month:"short", day:"numeric"}); }
    catch{ return "‚Äî"; }
  }

  const toastEl = document.getElementById("toast");
  let toastTimer = null;
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>toastEl.classList.remove("show"), 1400);
  }

  let session = loadJSON(K.SESSION, null);
  const settings = loadJSON(K.SETTINGS, {
    pilotName: "MindUrMind Pilot",
    schoolName: "Your School",
    schoolAggregationLocalOnly: true
  });

  const mainBody = document.getElementById("mainBody");
  const pageTitle = document.getElementById("pageTitle");
  const pageSubtitle = document.getElementById("pageSubtitle");
  const logoutBtn = document.getElementById("logoutBtn");
  const roleBadgeWrap = document.getElementById("roleBadgeWrap");
  const roleBadge = document.getElementById("roleBadge");
  const brandHome = document.getElementById("brandHome");
  const openFamily = document.getElementById("openFamily");
  const openAbout = document.getElementById("openAbout");

  function setPage(title, subtitle){ pageTitle.textContent = title; pageSubtitle.textContent = subtitle; }
  function mount(markup){ mainBody.innerHTML = markup; }
  function on(id, evt, handler){ const el = document.getElementById(id); if(el) el.addEventListener(evt, handler); }

  function setRoleBadge(role){
    roleBadgeWrap.style.display = "block";
    roleBadge.textContent = role === "student" ? "Student" : (role === "school" ? "School" : "Guest");
  }
  function clearRoleBadge(){ roleBadgeWrap.style.display = "none"; }

  function setSession(s){
    session = s;
    saveJSON(K.SESSION, session);
    logoutBtn.style.display = session ? "inline-flex" : "none";
    if(session) setRoleBadge(session.role); else clearRoleBadge();
  }
  function logout(){ setSession(null); renderSignIn(); }

  logoutBtn.addEventListener("click", logout);
  brandHome.addEventListener("click", (e)=>{ e.preventDefault(); session ? renderAppHome() : renderSignIn(); });
  openFamily.addEventListener("click", ()=>renderFamilyCorner());
  openAbout.addEventListener("click", ()=>renderAboutPrivacy());

  function getStudents(){ return loadJSON(K.STUDENTS, {}); }
  function saveStudents(map){ return saveJSON(K.STUDENTS, map); }

  function getCheckins(){ return loadJSON(K.CHECKINS, []); }
  function saveCheckins(arr){ return saveJSON(K.CHECKINS, arr); }

  function getHabits(){ return loadJSON(K.HABITS, {}); }
  function saveHabits(map){ return saveJSON(K.HABITS, map); }

  function getEcoActions(){ return loadJSON(K.ECOACTIONS, {}); }
  function saveEcoActions(map){ return saveJSON(K.ECOACTIONS, map); }

  function getCoachChat(){ return loadJSON(K.COACHCHAT, {}); }
  function saveCoachChat(map){ return saveJSON(K.COACHCHAT, map); }

  function getQuest(){ return loadJSON(K.QUEST, {}); }
  function saveQuest(map){ return saveJSON(K.QUEST, map); }

  // Initialize structures if missing
  if(!loadJSON(K.STUDENTS, null)) saveJSON(K.STUDENTS, {});
  if(!loadJSON(K.CHECKINS, null)) saveJSON(K.CHECKINS, []);
  if(!loadJSON(K.HABITS, null)) saveJSON(K.HABITS, {});
  if(!loadJSON(K.ECOACTIONS, null)) saveJSON(K.ECOACTIONS, {});
  if(!loadJSON(K.COACHCHAT, null)) saveJSON(K.COACHCHAT, {});
  if(!loadJSON(K.QUEST, null)) saveJSON(K.QUEST, {});

  function renderSignIn(){
    clearRoleBadge();
    logoutBtn.style.display = "none";
    setPage("Sign in", "Choose your role. This pilot is non-clinical and designed for wellbeing awareness, positive habits, and self-learning.");
    mount(`
      <div class="stack">
        <div class="note">
          <strong>Privacy-first pilot</strong><br>
          Student reflections stay on this device only. School insights are aggregated locally from participating students on this same device.
        </div>

        <div class="tabs" role="tablist" aria-label="Role selector">
          <button class="tab active" id="tabStudent" role="tab" aria-selected="true">Student</button>
          <button class="tab" id="tabSchool" role="tab" aria-selected="false">School</button>
        </div>

        <div id="rolePanel"></div>

        <div class="divider"></div>
        <div class="help">Tip: For demos, you can create a student profile in seconds. No email verification is required for this pilot prototype.</div>
      </div>
    `);

    function renderStudentPanel(){
      const students = getStudents();
      const list = Object.values(students);
      const options = list.map(s => `<option value="${escapeHTML(s.id)}">${escapeHTML(s.name)} (Grade ${escapeHTML(s.grade)})</option>`).join("");

      document.getElementById("rolePanel").innerHTML = `
        <div class="card" style="box-shadow:none; border-radius:18px; border:1px solid rgba(24,55,90,.10); background: rgba(255,255,255,.60)">
          <div class="card-body">
            <div class="stack">
              <div class="row">
                <div class="field">
                  <label for="studentPick">Existing student (optional)</label>
                  <select id="studentPick">
                    <option value="">‚Äî Select ‚Äî</option>
                    ${options}
                  </select>
                  <div class="help">If you already created a student on this device, pick them here to sign in quickly.</div>
                </div>
              </div>

              <div class="divider"></div>

              <div class="row">
                <div class="field">
                  <label for="studentName">Student name</label>
                  <input id="studentName" placeholder="e.g., Aisha" maxlength="32" />
                </div>
                <div class="field">
                  <label for="studentGrade">Grade</label>
                  <select id="studentGrade">
                    ${Array.from({length:8}, (_,i)=> `<option>${i+5}</option>`).join("")}
                  </select>
                </div>
              </div>

              <div class="row">
                <button class="btn primary" id="studentSignIn">Continue</button>
                <button class="btn" id="studentDemo">Use demo student</button>
              </div>

              <div class="note warn">
                <strong>Reminder</strong><br>
                This is not a clinical tool. If you feel unsafe, talk to a trusted adult or seek professional support.
              </div>
            </div>
          </div>
        </div>
      `;

      on("studentSignIn","click", ()=>{
        const pick = document.getElementById("studentPick").value.trim();
        if(pick){
          const s = getStudents()[pick];
          if(!s){ alert("Student not found on this device."); return; }
          setSession({role:"student", studentId:s.id, name:s.name});
          renderAppHome();
          return;
        }
        const name = document.getElementById("studentName").value.trim();
        const grade = document.getElementById("studentGrade").value.trim();
        if(name.length < 2){ alert("Please enter a student name (at least 2 characters)."); return; }
        const map = getStudents();
        const id = uid();
        map[id] = {id, name, grade, createdAt: nowISO()};
        saveStudents(map);
        setSession({role:"student", studentId:id, name});
        renderAppHome();
      });

      on("studentDemo","click", ()=>{
        const map = getStudents();
        const id = uid();
        map[id] = {id, name:"Demo Student", grade:"8", createdAt: nowISO()};
        saveStudents(map);
        setSession({role:"student", studentId:id, name:"Demo Student"});
        renderAppHome();
      });

      on("studentPick","change", (e)=>{
        if(e.target.value){
          const s = getStudents()[e.target.value];
          if(s){
            document.getElementById("studentName").value = s.name;
            document.getElementById("studentGrade").value = s.grade;
          }
        }
      });
    }

    function renderSchoolPanel(){
      document.getElementById("rolePanel").innerHTML = `
        <div class="card" style="box-shadow:none; border-radius:18px; border:1px solid rgba(24,55,90,.10); background: rgba(255,255,255,.60)">
          <div class="card-body">
            <div class="stack">
              <div class="note ok">
                <strong>School view is aggregated & local</strong><br>
                Insights shown here are computed from students who used this same device. No individual entries are shown.
              </div>

              <div class="row">
                <div class="field">
                  <label for="schoolPin">School access PIN (demo)</label>
                  <input id="schoolPin" placeholder="Enter PIN (default: 1234)" inputmode="numeric" maxlength="8"/>
                  <div class="help">This prototype uses a simple PIN for demo. In a real pilot, this would be managed by the school.</div>
                </div>
              </div>

              <div class="row">
                <button class="btn primary" id="schoolSignIn">Continue</button>
              </div>

              <div class="note warn">
                <strong>No AI in School view</strong><br>
                School dashboard is passive (insights + suggested actions) to avoid any perception of monitoring or evaluation.
              </div>
            </div>
          </div>
        </div>
      `;

      on("schoolSignIn","click", ()=>{
        const pin = document.getElementById("schoolPin").value.trim();
        if(pin !== "1234"){ alert("Incorrect PIN for this demo. Try 1234."); return; }
        setSession({role:"school", name: settings.schoolName});
        renderAppHome();
      });
    }

    const tabStudent = document.getElementById("tabStudent");
    const tabSchool = document.getElementById("tabSchool");
    function activate(which){
      if(which==="student"){
        tabStudent.classList.add("active"); tabStudent.setAttribute("aria-selected","true");
        tabSchool.classList.remove("active"); tabSchool.setAttribute("aria-selected","false");
        renderStudentPanel();
      }else{
        tabSchool.classList.add("active"); tabSchool.setAttribute("aria-selected","true");
        tabStudent.classList.remove("active"); tabStudent.setAttribute("aria-selected","false");
        renderSchoolPanel();
      }
    }
    tabStudent.addEventListener("click", ()=>activate("student"));
    tabSchool.addEventListener("click", ()=>activate("school"));
    activate("student");
  }

  function renderAppHome(){
    if(!session){ renderSignIn(); return; }
    logoutBtn.style.display = "inline-flex";
    setRoleBadge(session.role);
    if(session.role === "student") renderStudentHome();
    else if(session.role === "school") renderSchoolHome();
    else renderSignIn();
  }

  // ---------------------------
  // STUDENT HOME
  // ---------------------------
  function renderStudentHome(){
    const name = session.name || "Student";
    setPage("Student dashboard", `Welcome, ${name}. Your reflections stay on this device. This pilot shares nothing individually.`);

    mount(`
      <div class="stack">
        <div class="pillrow">
          <span class="pill">üë§ <b>${escapeHTML(name)}</b></span>
          <span class="pill">üîí Device-only reflections</span>
          <span class="pill">üß≠ Non-clinical wellbeing awareness</span>
        </div>

        <div class="quickgrid" aria-label="Quick actions">
          <button class="tile" id="tileCheckin"><div class="t">‚úÖ Check-in</div><p class="s">Quick mood + optional note (private, on-device).</p></button>
          <button class="tile" id="tileHabits"><div class="t">üèÅ Habits</div><p class="s">Small daily habits that support wellbeing.</p></button>
          <button class="tile" id="tileClimate"><div class="t">üåç Climate Feelings (Eco-Anxiety)</div><p class="s">A 2-minute guide: calm your mind + one small action.</p></button>
          <button class="tile" id="tileGame"><div class="t">üéÆ Calm Garden (mini-game)</div><p class="s">A gentle focus game paired with slow breathing.</p></button>
        </div>

        <div class="tabs" role="tablist" aria-label="Student tabs">
          <button class="tab active" id="sTabCheckin" role="tab" aria-selected="true">Check-in</button>
          <button class="tab" id="sTabHabits" role="tab" aria-selected="false">Habits</button>
          <button class="tab" id="sTabClimate" role="tab" aria-selected="false">Climate Feelings</button>
          <button class="tab" id="sTabGame" role="tab" aria-selected="false">Mini-game</button>
          <button class="tab" id="sTabLearn" role="tab" aria-selected="false">Learn</button>
          <button class="tab" id="sTabCoach" role="tab" aria-selected="false">AI wellbeing coach</button>
          <button class="tab" id="sTabQuest" role="tab" aria-selected="false">Emotion Quest</button>
          <button class="tab" id="sTabHistory" role="tab" aria-selected="false">My history</button>
        </div>

        <div id="studentPanel"></div>
      </div>
    `);

    function activate(tab){
      const map = {
        checkin: ["sTabCheckin", renderStudentCheckin],
        habits: ["sTabHabits", renderStudentHabits],
        climate: ["sTabClimate", renderStudentClimate],
        game: ["sTabGame", renderStudentGame],
        learn: ["sTabLearn", renderStudentLearn],
        coach: ["sTabCoach", renderStudentCoach],
        quest: ["sTabQuest", renderEmotionQuest],
        history: ["sTabHistory", renderStudentHistory]
      };
      Object.keys(map).forEach(k=>{
        const [id] = map[k];
        const el = document.getElementById(id);
        if(!el) return;
        const isActive = (k===tab);
        el.classList.toggle("active", isActive);
        el.setAttribute("aria-selected", isActive ? "true" : "false");
      });
      map[tab][1]();
    }

    on("sTabCheckin","click", ()=>activate("checkin"));
    on("sTabHabits","click", ()=>activate("habits"));
    on("sTabClimate","click", ()=>activate("climate"));
    on("sTabGame","click", ()=>activate("game"));
    on("sTabLearn","click", ()=>activate("learn"));
    on("sTabCoach","click", ()=>activate("coach"));
    on("sTabQuest","click", ()=>activate("quest"));
    on("sTabHistory","click", ()=>activate("history"));

    on("tileCheckin","click", ()=>activate("checkin"));
    on("tileHabits","click", ()=>activate("habits"));
    on("tileClimate","click", ()=>activate("climate"));
    on("tileGame","click", ()=>activate("game"));

    activate("checkin");
  }

  // ---------------------------
  // CHECK-IN
  // ---------------------------
  function renderStudentCheckin(){
    const panel = document.getElementById("studentPanel");
    const sid = session.studentId;
    const checkins = loadJSON(K.CHECKINS, []).filter(c => c.studentId === sid);
    const today = todayKey();
    const alreadyToday = checkins.some(c => c.day === today);

    panel.innerHTML = `
      <div class="card" style="box-shadow:none; border-radius:18px; background: rgba(255,255,255,.60); border:1px solid rgba(24,55,90,.10)">
        <div class="card-body">
          <div class="stack">
            <div class="note ${alreadyToday ? "ok" : ""}">
              <strong>Today‚Äôs check-in</strong><br>
              ${alreadyToday ? "You already checked in today. You can still add another note if you want." : "A quick check-in helps you notice patterns and build healthy habits."}
              <div class="help" style="margin-top:8px">Reminder: your note stays on your device. No one else sees it.</div>
            </div>

            <div class="row">
              <div class="field">
                <label for="mood">How do you feel right now?</label>
                <select id="mood">
                  <option value="calm">üôÇ Calm</option>
                  <option value="okay">üòå Okay</option>
                  <option value="stressed">üòü Stressed</option>
                  <option value="sad">üòû Sad</option>
                  <option value="angry">üò† Angry</option>
                  <option value="tired">ü•± Tired</option>
                  <option value="excited">ü§© Excited</option>
                </select>
              </div>

              <div class="field">
                <label for="sleep">Sleep last night (hours)</label>
                <input id="sleep" type="number" min="0" max="16" step="0.5" inputmode="decimal" placeholder="e.g., 7.5" />
                <div class="help">Used for your own habits + local aggregation (no identity).</div>
              </div>

              <div class="field">
                <label for="study">Focused study today (minutes)</label>
                <input id="study" type="number" min="0" max="600" step="5" inputmode="numeric" placeholder="e.g., 60" />
              </div>
            </div>

            <div class="row">
              <div class="field" style="min-width:280px; flex:2">
                <label for="note">Optional private note (on-device only)</label>
                <textarea id="note" placeholder="Anything you want to remember ‚Äî feelings, triggers, wins, gratitude..."></textarea>
                <div class="help">Tip: keep it simple. Even 1 line is enough.</div>
              </div>
            </div>

            <div class="row">
              <button class="btn primary" id="saveCheckin">Save check-in</button>
              <button class="btn" id="quickReset">Clear fields</button>
            </div>

            <div class="divider"></div>
            <div class="help">If you feel overwhelmed right now: breathe in 4, hold 2, out 6. Repeat twice.</div>
          </div>
        </div>
      </div>
    `;

    on("quickReset","click", ()=>{
      document.getElementById("sleep").value = "";
      document.getElementById("study").value = "";
      document.getElementById("note").value = "";
      document.getElementById("mood").value = "calm";
      toast("Cleared");
    });

    on("saveCheckin","click", ()=>{
      const mood = document.getElementById("mood").value;
      const sleepRaw = document.getElementById("sleep").value;
      const studyRaw = document.getElementById("study").value;
      const note = document.getElementById("note").value.trim();

      const sleep = sleepRaw === "" ? null : clamp(parseFloat(sleepRaw), 0, 16);
      const study = studyRaw === "" ? null : clamp(parseInt(studyRaw, 10), 0, 600);

      const rec = { id: uid(), studentId: sid, day: todayKey(), mood, sleep, study, note, createdAt: nowISO() };
      const all = getCheckins();
      all.push(rec);
      if(!saveCheckins(all)){ alert("Could not save (storage full or blocked)."); return; }
      toast("Saved ‚úì");
      renderStudentCheckin();
    });
  }

  // ---------------------------
  // HABITS
  // ---------------------------
  function renderStudentHabits(){
    const panel = document.getElementById("studentPanel");
    const sid = session.studentId;
    const habitsMap = getHabits();
    const my = habitsMap[sid] || { water: [], move: [], screenBreak: [], gratitude: [], bedtime: [] };
    ["water","move","screenBreak","gratitude","bedtime"].forEach(k=>{ if(!Array.isArray(my[k])) my[k]=[]; });

    function isDoneToday(arr){ return arr.includes(todayKey()); }
    function toggle(arr){
      const t = todayKey();
      const idx = arr.indexOf(t);
      if(idx >= 0) arr.splice(idx,1); else arr.push(t);
    }

    panel.innerHTML = `
      <div class="stack">
        <div class="note">
          <strong>Small habits. Big impact.</strong><br>
          Choose just 1‚Äì2 habits to focus on this week. Consistency matters more than perfection.
        </div>

        <div class="kpi">
          <div class="box"><div class="t">Check-ins saved</div><div class="v">${getCheckins().filter(c=>c.studentId===sid).length}</div></div>
          <div class="box"><div class="t">Habits done today</div><div class="v" id="habitsDoneKpi">‚Äî</div></div>
          <div class="box"><div class="t">Focus window</div><div class="v">1 week</div></div>
        </div>

        <div class="card" style="box-shadow:none; border-radius:18px; background: rgba(255,255,255,.60); border:1px solid rgba(24,55,90,.10)">
          <div class="card-body">
            <div class="stack">
              ${habitRow("üíß Drink water", "water", "Even 1 extra glass helps your energy.")}
              ${habitRow("üö∂ Move your body", "move", "A short walk counts.")}
              ${habitRow("üìµ Take a screen break", "screenBreak", "2 minutes away from the screen resets your brain.")}
              ${habitRow("üôè Gratitude (1 line)", "gratitude", "Write one good thing from today.")}
              ${habitRow("üåô Bedtime routine", "bedtime", "Small steps: dim lights, no phone 15 min.")}
              <div class="row">
                <button class="btn primary" id="saveHabits">Save habits</button>
                <button class="btn" id="resetHabits">Clear today</button>
              </div>
              <div class="help">Habits are stored on this device only.</div>
            </div>
          </div>
        </div>
      </div>
    `;

    function habitRow(title, key, desc){
      const done = isDoneToday(my[key]);
      const status = done ? `<span class="oktext">Done today</span>` : `<span class="muted">Not done yet</span>`;
      return `
        <div class="item">
          <div class="row" style="align-items:center; justify-content:space-between">
            <div>
              <h3 style="margin:0">${title}</h3>
              <p>${escapeHTML(desc)}</p>
              <div class="help" style="margin-top:6px">${status}</div>
            </div>
            <div><button class="btn smallbtn" id="toggle_${key}">${done ? "Undo" : "Mark done"}</button></div>
          </div>
        </div>
      `;
    }

    ["water","move","screenBreak","gratitude","bedtime"].forEach(key=>{
      on(`toggle_${key}`,"click", ()=>{
        toggle(my[key]);
        renderStudentHabits();
      });
    });

    function updateKpi(){
      const doneCount = ["water","move","screenBreak","gratitude","bedtime"].reduce((acc,k)=>acc + (isDoneToday(my[k])?1:0), 0);
      const el = document.getElementById("habitsDoneKpi");
      if(el) el.textContent = String(doneCount);
    }
    updateKpi();

    on("saveHabits","click", ()=>{
      habitsMap[sid] = my;
      if(!saveHabits(habitsMap)){ alert("Could not save (storage full or blocked)."); return; }
      toast("Saved ‚úì");
      renderStudentHabits();
    });

    on("resetHabits","click", ()=>{
      const t = todayKey();
      ["water","move","screenBreak","gratitude","bedtime"].forEach(k=>{
        my[k] = (my[k]||[]).filter(d=>d!==t);
      });
      habitsMap[sid] = my;
      saveHabits(habitsMap);
      toast("Cleared today");
      renderStudentHabits();
    });
  }

  // ---------------------------
  // CLIMATE FEELINGS (Eco-Anxiety) ‚Äî auto-save toggles
  // ---------------------------
  function renderStudentClimate(){
    const panel = document.getElementById("studentPanel");
    const sid = session.studentId;
    const ecoMap = getEcoActions();
    const my = Array.isArray(ecoMap[sid]) ? ecoMap[sid] : [];
    const today = todayKey();

    const ACTIONS = [
      {key:"refill",   label:"Refill bottle today",        desc:"One small routine reduces waste."},
      {key:"lights",   label:"Switch off lights",          desc:"A simple habit that saves energy."},
      {key:"plastic1", label:"One plastic-free item",      desc:"Just one item is enough."},
      {key:"plant",    label:"Care for a plant/seed",      desc:"Even a small plant matters."},
      {key:"share",    label:"Share one solution story",   desc:"Balance worry with hope."}
    ];

    function isDone(key){ return my.some(x => x.day === today && x.key === key); }
    function toggle(key){
      const idx = my.findIndex(x => x.day === today && x.key === key);
      if(idx >= 0) my.splice(idx,1);
      else my.push({day: today, key, at: nowISO()});
      ecoMap[sid] = my;
      saveEcoActions(ecoMap);
    }
    function doneCountToday(){ return ACTIONS.reduce((acc,a)=>acc + (isDone(a.key)?1:0), 0); }

    panel.innerHTML = `
      <div class="stack">
        <div class="note ok">
          <strong>üåç Climate Feelings (Eco-Anxiety)</strong><br>
          Feeling worried, sad, or angry about the environment is common. It means you care ‚Äî and caring is a strength.
          <div class="help" style="margin-top:8px">This is not a diagnosis. It‚Äôs a short guide to calm your mind and take one small action.</div>
        </div>

        <div class="card" style="box-shadow:none; border-radius:18px; background: rgba(255,255,255,.60); border:1px solid rgba(24,55,90,.10)">
          <div class="card-body">
            <div class="stack">
              <div class="row">
                <button class="btn primary" id="climateReset">1-minute reset</button>
                <button class="btn" id="climateControl">Circle of control</button>
                <button class="btn" id="climateMedia">Healthy media tip</button>
                <button class="btn" id="climateCoachJump">Ask the AI coach</button>
              </div>

              <div id="climateOut" class="note" style="display:none"></div>

              <div class="divider"></div>

              <div class="note">
                <strong>Pick ONE small action (auto-saved)</strong><br>
                Choose one action for today. Small is powerful. No guilt. No perfection.
                <div class="help" style="margin-top:6px">Saved on this device only. Not shared individually.</div>
              </div>

              <div class="kpi">
                <div class="box"><div class="t">Actions done today</div><div class="v" id="ecoDoneKpi">${doneCountToday()}</div></div>
                <div class="box"><div class="t">Suggestion</div><div class="v">Pick 1</div></div>
                <div class="box"><div class="t">Time</div><div class="v">‚â§ 10 min</div></div>
              </div>

              <div class="list">
                ${ACTIONS.map(a => `
                  <div class="item">
                    <div class="row" style="align-items:center; justify-content:space-between">
                      <div>
                        <h3>${escapeHTML(a.label)}</h3>
                        <p>${escapeHTML(a.desc)}</p>
                        <div class="help" style="margin-top:6px">${isDone(a.key) ? `<span class="oktext">Done today</span>` : `<span class="muted">Not done yet</span>`}</div>
                      </div>
                      <div><button class="btn smallbtn" id="eco_${a.key}">${isDone(a.key) ? "Undo" : "Mark done"}</button></div>
                    </div>
                  </div>
                `).join("")}
              </div>

              <div class="row"><button class="btn" id="clearEcoToday">Clear today</button></div>

              <div class="note warn">
                <strong>When to talk to someone</strong><br>
                If climate worries affect your sleep, mood, or focus for weeks, talk to a trusted adult or school counselor.
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    function showOut(htmlContent){
      const out = document.getElementById("climateOut");
      out.style.display = "block";
      out.innerHTML = htmlContent;
    }

    on("climateReset","click", ()=>{
      showOut(`
        <strong>1-minute reset</strong><br>
        Try this twice:<br><br>
        <ol style="margin:8px 0 0; padding-left:18px; color: rgba(16,33,58,.88); line-height:1.55">
          <li>Breathe in for 4</li>
          <li>Hold for 2</li>
          <li>Breathe out slowly for 6</li>
        </ol>
        <div class="help" style="margin-top:10px">Notice: shoulders down, jaw relaxed, slow exhale.</div>
      `);
    });

    on("climateControl","click", ()=>{
      showOut(`
        <strong>Circle of control</strong><br>
        When the problem feels huge, shrink it to what you can control today:
        <div class="divider"></div>
        <div class="row" style="margin:0">
          <div class="item" style="flex:1; margin:0">
            <h3>‚úÖ I can control</h3>
            <p>My actions, my choices, my routines, what I share, how I speak about it.</p>
          </div>
          <div class="item" style="flex:1; margin:0">
            <h3>‚ùå I can‚Äôt control</h3>
            <p>Everything happening globally, other people‚Äôs choices, all outcomes.</p>
          </div>
        </div>
        <div class="help" style="margin-top:10px">Choose one small action below ‚Äî that‚Äôs enough.</div>
      `);
    });

    on("climateMedia","click", ()=>{
      showOut(`
        <strong>Healthy media tip</strong><br>
        Balance awareness with calm:
        <ul style="margin:10px 0 0; padding-left:18px; color: rgba(16,33,58,.88); line-height:1.55">
          <li>Limit heavy climate news to <b>10 minutes</b> per day.</li>
          <li>Avoid doom content before sleep.</li>
          <li>Add one ‚Äúsolution story‚Äù for every ‚Äúproblem story‚Äù.</li>
        </ul>
      `);
    });

    on("climateCoachJump","click", ()=>{
      const tab = document.getElementById("sTabCoach");
      if(tab) tab.click();
    });

    ACTIONS.forEach(a=>{
      on(`eco_${a.key}`,"click", ()=>{
        toggle(a.key);
        toast("Saved ‚úì");
        renderStudentClimate();
      });
    });

    on("clearEcoToday","click", ()=>{
      const filtered = my.filter(x => x.day !== today);
      ecoMap[sid] = filtered;
      saveEcoActions(ecoMap);
      toast("Cleared today");
      renderStudentClimate();
    });
  }

  // ---------------------------
  // CALM GARDEN mini-game
  // ---------------------------
  function renderStudentGame(){
    const panel = document.getElementById("studentPanel");
    panel.innerHTML = `
      <div class="stack">
        <div class="note ok">
          <strong>üéÆ Calm Garden (mini-game)</strong><br>
          Tap the floating leaves gently while you breathe slowly. This trains calm attention ‚Äî no scores are shared.
          <div class="help" style="margin-top:8px">Try: inhale 4 ‚Ä¢ hold 2 ‚Ä¢ exhale 6 (repeat).</div>
        </div>

        <div class="gameWrap">
          <div class="gameHUD">
            <span class="hudPill" id="hudBreath">üå¨Ô∏è Breathe: 4 ‚Ä¢ 2 ‚Ä¢ 6</span>
            <span class="hudPill" id="hudScore">üçÉ Leaves: 0</span>
            <span class="hudPill" id="hudTime">‚è±Ô∏è 60s</span>
          </div>
          <canvas id="gameCanvas" width="1000" height="500" aria-label="Calm Garden game canvas"></canvas>
        </div>

        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="help">Tip: Focus on slow exhale. If you feel tense, relax your shoulders and soften your gaze.</div>
          <div class="row">
            <button class="btn primary" id="gameStart">Start 60s</button>
            <button class="btn" id="gameReset">Reset</button>
          </div>
        </div>

        <div class="note warn">
          <strong>Boundary</strong><br>
          If you notice you‚Äôre using games to avoid life tasks, pause and try a 1-minute breathing reset instead.
        </div>
      </div>
    `;

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const hudScore = document.getElementById("hudScore");
    const hudTime = document.getElementById("hudTime");
    const prefersReduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    let running=false, score=0, timeLeft=60, lastT=0, timerAcc=0;
    const leaves = [];
    const LEAF_COUNT = 10;

    function rand(a,b){ return a + Math.random()*(b-a); }
    function spawnLeaf(){
      return { x: rand(60, canvas.width-60), y: rand(80, canvas.height-80),
        r: rand(18, 28),
        vx: rand(-18, 18) * (prefersReduced ? 0.6 : 1),
        vy: rand(-12, 12) * (prefersReduced ? 0.6 : 1),
        wob: rand(0, Math.PI*2)
      };
    }
    function resetLeaves(){ leaves.length=0; for(let i=0;i<LEAF_COUNT;i++) leaves.push(spawnLeaf()); }
    resetLeaves();

    function drawBackground(){
      const g = ctx.createLinearGradient(0,0,0,canvas.height);
      g.addColorStop(0,"rgba(59,185,255,.18)");
      g.addColorStop(1,"rgba(65,215,160,.14)");
      ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

      for(let i=0;i<10;i++){
        const x = (i*110 + (prefersReduced?0:(performance.now()/30)%110)) % (canvas.width+120) - 60;
        const y = 70 + i*35;
        ctx.beginPath();
        ctx.fillStyle="rgba(255,255,255,.35)";
        ctx.arc(x,y,22,0,Math.PI*2);
        ctx.fill();
      }

      ctx.fillStyle="rgba(255,255,255,.45)";
      ctx.fillRect(0, canvas.height-70, canvas.width, 70);
      ctx.fillStyle="rgba(65,215,160,.20)";
      ctx.fillRect(0, canvas.height-70, canvas.width, 12);
    }

    function drawLeaf(l){
      ctx.save();
      ctx.translate(l.x, l.y);
      const wob = Math.sin(l.wob) * (prefersReduced ? 0.25 : 0.45);
      ctx.rotate(wob);

      ctx.beginPath();
      ctx.moveTo(0, -l.r);
      ctx.quadraticCurveTo(l.r, -l.r*0.2, 0, l.r);
      ctx.quadraticCurveTo(-l.r, -l.r*0.2, 0, -l.r);
      ctx.closePath();

      const lg = ctx.createLinearGradient(-l.r, -l.r, l.r, l.r);
      lg.addColorStop(0, "rgba(65,215,160,.72)");
      lg.addColorStop(1, "rgba(59,185,255,.55)");
      ctx.fillStyle = lg;
      ctx.fill();

      ctx.strokeStyle="rgba(255,255,255,.55)";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(0,-l.r*0.8);
      ctx.lineTo(0,l.r*0.85);
      ctx.stroke();

      ctx.restore();
    }

    function tick(t){
      if(!lastT) lastT = t;
      const dt = Math.min(0.04, (t-lastT)/1000);
      lastT = t;

      drawBackground();

      for(const l of leaves){
        l.wob += dt * (prefersReduced ? 0.9 : 1.6);
        if(running){
          l.x += l.vx * dt;
          l.y += l.vy * dt;
          if(l.x < 50 || l.x > canvas.width-50) l.vx *= -1;
          if(l.y < 60 || l.y > canvas.height-90) l.vy *= -1;
        }
        drawLeaf(l);
      }

      if(running){
        timerAcc += dt;
        if(timerAcc >= 1){
          timerAcc = 0;
          timeLeft = Math.max(0, timeLeft-1);
          hudTime.textContent = "‚è±Ô∏è " + timeLeft + "s";
          if(timeLeft === 0){
            running = false;
            toast("Nice work ‚ú®");
          }
        }
      }

      requestAnimationFrame(tick);
    }

    function startGame(){
      score = 0; timeLeft = 60; timerAcc=0;
      hudScore.textContent = "üçÉ Leaves: 0";
      hudTime.textContent = "‚è±Ô∏è 60s";
      running = true;
      toast("Start ‚úì");
    }
    function resetGame(){
      running=false; score=0; timeLeft=60; timerAcc=0;
      resetLeaves();
      hudScore.textContent = "üçÉ Leaves: 0";
      hudTime.textContent = "‚è±Ô∏è 60s";
      toast("Reset ‚úì");
    }
    function handleTap(px, py){
      if(!running) return;
      for(const l of leaves){
        const dx = px - l.x, dy = py - l.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist <= l.r*1.05){
          score += 1;
          hudScore.textContent = "üçÉ Leaves: " + score;
          l.x = Math.max(60, Math.min(canvas.width-60, l.x + rand(-240,240)));
          l.y = Math.max(80, Math.min(canvas.height-90, l.y + rand(-160,160)));
          toast("Good ‚úì");
          break;
        }
      }
    }

    canvas.addEventListener("click", (e)=>{
      const rect = canvas.getBoundingClientRect();
      const x = (e.clientX - rect.left) * (canvas.width / rect.width);
      const y = (e.clientY - rect.top) * (canvas.height / rect.height);
      handleTap(x,y);
    }, {passive:true});

    canvas.addEventListener("touchstart", (e)=>{
      if(!e.touches || !e.touches.length) return;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
      const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
      handleTap(x,y);
    }, {passive:true});

    on("gameStart","click", startGame);
    on("gameReset","click", resetGame);
    requestAnimationFrame(tick);
  }

  // ---------------------------
  // LEARN
  // ---------------------------
  function renderStudentLearn(){
    const panel = document.getElementById("studentPanel");
    panel.innerHTML = `
      <div class="stack">
        <div class="note ok">
          <strong>Learn (self-learning)</strong><br>
          Short, student-friendly resources you can use anytime. No quizzes, no ‚Äúscores‚Äù.
        </div>

        <div class="list">
          ${learnCard("üß† Understanding emotions", "Emotions are signals ‚Äî not commands. Learn how to name them and respond wisely.",
            ["Name it (30 seconds)", "Body scan: where do you feel it?", "One helpful next step"])}
          ${learnCard("üå¨Ô∏è Quick calm tools", "Simple techniques that reduce stress in under 2 minutes.",
            ["4‚Äì2‚Äì6 breathing", "5-4-3-2-1 grounding", "Shoulder drop + slow exhale"])}
          ${learnCard("üéÆ Calm Garden", "A gentle mini-game for calm attention (no sharing).",
            ["Tap floating leaves", "Breathe slowly as you play", "Stop at 60 seconds"])}
          ${learnCard("üìö Study focus", "Build focus with tiny steps and protect your energy.",
            ["Pomodoro (25/5)", "Remove 1 distraction", "Start with 2 minutes"])}
          ${learnCard("üõå Sleep basics", "Sleep supports mood, memory, and learning ‚Äî even small improvements matter.",
            ["Same wake time", "Screen down 30 min", "Wind-down routine"])}
          ${learnCard("üåç Climate feelings", "If climate news feels heavy, use a calm reset + one small action.",
            ["Open: Climate Feelings", "Circle of control", "Pick 1 micro-action"])}
          ${learnCard("ü§ù Asking for help", "Strong people ask for help early, not late.",
            ["Talk to a trusted adult", "School counselor / teacher", "If unsafe: emergency services"])}
        </div>

        <div class="row">
          <button class="btn" id="goCoachFromLearn">Open AI wellbeing coach</button>
          <button class="btn" id="goQuestFromLearn">Play Emotion Quest</button>
        </div>
      </div>
    `;

    function learnCard(title, desc, bullets){
      return `
        <div class="item">
          <h3>${escapeHTML(title)}</h3>
          <p>${escapeHTML(desc)}</p>
          <div class="divider"></div>
          <div class="help">
            <ul style="margin:0; padding-left:18px; color: rgba(16,33,58,.72); line-height:1.55">
              ${bullets.map(b=>`<li>${escapeHTML(b)}</li>`).join("")}
            </ul>
          </div>
        </div>
      `;
    }

    on("goCoachFromLearn","click", ()=>{ const tab=document.getElementById("sTabCoach"); if(tab) tab.click(); });
    on("goQuestFromLearn","click", ()=>{ const tab=document.getElementById("sTabQuest"); if(tab) tab.click(); });
  }

  // ============================================================
  // FEATURE 1: AI WELLBEING COACH (old style)
  // - exact wording + quick tips + safety text
  // - offline, rule-based suggestions (no external API)
  // - messages stored on device only (studentId-scoped)
  // ============================================================
  function renderStudentCoach(){
    const panel = document.getElementById("studentPanel");
    const sid = session.studentId;

    const chatMap = getCoachChat();
    const thread = Array.isArray(chatMap[sid]) ? chatMap[sid] : [];
    if(thread.length === 0){
      // Seed with your exact intro lines
      thread.push(
        {who:"coach", text:"Tools, tips, and an AI coach for general guidance.", at: nowISO()},
        {who:"coach", text:"AI wellbeing coach", at: nowISO()},
        {who:"coach", text:"Ask about stress, sleep, confidence, focus, friendships, or anger.", at: nowISO()},
        {who:"coach", text:"Hi! Tell me what‚Äôs going on, and I‚Äôll suggest a few steps.", at: nowISO()},
        {who:"coach", text:"You can say: ‚ÄúI‚Äôm stressed about exams‚Äù, ‚ÄúI can‚Äôt sleep‚Äù, ‚ÄúI feel sad‚Äù, ‚ÄúI can‚Äôt focus‚Äù, ‚Äúfriend issues‚Äù, ‚Äúanger‚Äù..........", at: nowISO()}
      );
      chatMap[sid] = thread;
      saveCoachChat(chatMap);
    }

    panel.innerHTML = `
      <div class="stack">
        <div class="note ok">
          <strong>AI wellbeing coach</strong><br>
          Tools, tips, and an AI coach for general guidance.
          <div class="help" style="margin-top:8px">This is for learning coping skills. It doesn‚Äôt diagnose.</div>
        </div>

        <div class="chatWrap">
          <div class="chatLog" id="chatLog" aria-label="AI wellbeing coach chat log"></div>

          <div class="divider"></div>

          <div class="row" style="align-items:flex-end">
            <div class="field" style="min-width:260px; flex:2">
              <label for="coachInput">Type a message‚Ä¶</label>
              <textarea id="coachInput" placeholder="Type a message‚Ä¶"></textarea>
              <div class="help">Notes and journal entries are private ,,,,,...</div>
            </div>
            <div class="row" style="align-items:flex-end">
              <button class="btn primary" id="coachSend">Send</button>
              <button class="btn" id="coachExamples">Examples</button>
              <button class="btn danger" id="coachClear">Clear chat</button>
            </div>
          </div>

          <div class="note warn">
            <strong>Safety & support</strong><br>
            Talk to a trusted adult (parent/guardian/teacher).<br>
            Use Calm Toolkit for 60 seconds and re-check how you feel.<br>
            If you feel unsafe: tell an adult immediately and call local emergency/helpline numbers.
          </div>
        </div>

        <div class="item">
          <h3>Self-help quick tips</h3>
          <p class="muted">
            Stress: 60 seconds breathing + one tiny task.<br>
            Anger: pause, 3 breaths, step away for 2 minutes.<br>
            Sad: talk to someone safe; do one gentle activity.<br>
            Overthinking: write worry ‚Üí write a fair response.<br>
            Peer pressure: practise ‚ÄúNo, I‚Äôm not comfortable.‚Äù
          </p>
        </div>

        <div class="help dangertext">
          If you feel unsafe or think you might harm yourself, stop and tell a trusted adult immediately.
        </div>
      </div>
    `;

    function renderChat(){
      const log = document.getElementById("chatLog");
      if(!log) return;
      log.innerHTML = thread.map(m=>{
        const who = m.who === "user" ? "You" : "Coach";
        const cls = m.who === "user" ? "bubble user" : "bubble";
        return `
          <div class="msg">
            <div class="who">${escapeHTML(who)}</div>
            <div class="${cls}">${escapeHTML(m.text)}</div>
          </div>
        `;
      }).join("");
      // scroll to bottom
      log.scrollTop = log.scrollHeight;
    }

    function persist(){
      const cm = getCoachChat();
      cm[sid] = thread;
      saveCoachChat(cm);
    }

    function coachReply(userText){
      // Crisis keywords ‚Üí safety prompt (non-negotiable)
      const t = userText.toLowerCase();
      const dangerWords = ["suicide","kill myself","self harm","hurt myself","end my life","die","i want to die"];
      if(dangerWords.some(w=>t.includes(w))){
        return "If you feel unsafe or think you might harm yourself, stop and tell a trusted adult immediately. If you are in immediate danger, call local emergency/helpline numbers right now.";
      }

      // Topic detection
      const topics = [];
      if(t.includes("exam") || t.includes("test") || t.includes("grades") || t.includes("school")) topics.push("exams");
      if(t.includes("stress") || t.includes("stressed") || t.includes("anx") || t.includes("worry")) topics.push("stress");
      if(t.includes("sleep") || t.includes("can't sleep") || t.includes("insomnia") || t.includes("tired")) topics.push("sleep");
      if(t.includes("sad") || t.includes("low") || t.includes("down") || t.includes("cry")) topics.push("sad");
      if(t.includes("focus") || t.includes("concentr") || t.includes("distract")) topics.push("focus");
      if(t.includes("friend") || t.includes("friends") || t.includes("ignore") || t.includes("friend issues")) topics.push("friends");
      if(t.includes("anger") || t.includes("angry") || t.includes("mad") || t.includes("furious")) topics.push("anger");
      if(t.includes("confidence") || t.includes("insecure") || t.includes("self esteem") || t.includes("embarrass")) topics.push("confidence");

      // Build response: ‚Äúa few steps‚Äù
      const steps = [];
      // universal first step
      steps.push("First: try 60 seconds breathing (inhale 4, hold 2, exhale 6) twice.");

      if(topics.includes("stress") || topics.includes("exams")){
        steps.push("Next: pick ONE tiny task (2‚Äì10 minutes) to start. Starting reduces stress faster than thinking.");
        steps.push("Make a mini plan: write 3 tasks ‚Üí choose the easiest first ‚Üí do 10 minutes.");
      }
      if(topics.includes("sleep")){
        steps.push("Tonight: dim lights + stop heavy scrolling 30 minutes before bed.");
        steps.push("Try: write your worries on paper, then write one fair response.");
        steps.push("Keep a consistent wake-up time. That often helps more than forcing sleep.");
      }
      if(topics.includes("focus")){
        steps.push("Remove one distraction (notifications / extra tabs).");
        steps.push("Do a ‚Äò2-minute start‚Äô. If it goes well, continue for 10 minutes.");
        steps.push("Try Pomodoro: 25 minutes focus, 5 minutes break.");
      }
      if(topics.includes("friends")){
        steps.push("If it feels safe: ask calmly later: ‚ÄúHey, are we okay?‚Äù");
        steps.push("Avoid guessing worst-case reasons. Ask for clarity once, kindly.");
        steps.push("If they keep ignoring you repeatedly, talk to a trusted adult or counselor for support.");
      }
      if(topics.includes("anger")){
        steps.push("Pause: take 3 breaths, step away for 2 minutes, then come back.");
        steps.push("Say one calm sentence about your need (not an attack). Example: ‚ÄúI need a break.‚Äù");
      }
      if(topics.includes("sad")){
        steps.push("Do one gentle activity: water, short walk, shower, or music ‚Äî small care matters.");
        steps.push("Talk to someone safe today (friend/parent/teacher). Don‚Äôt carry it alone.");
      }
      if(topics.includes("confidence")){
        steps.push("Write one strength you used this week, even if small.");
        steps.push("Try a ‚Äòtiny brave action‚Äô today (answer once in class, ask one question, or practice 5 minutes).");
      }

      // If no topics recognized, keep it general but still helpful
      if(topics.length === 0){
        steps.push("Tell me which area fits best: stress, sleep, confidence, focus, friendships, or anger ‚Äî and I‚Äôll suggest steps.");
        steps.push("Meanwhile: write your worry ‚Üí write a fair response (not harsh, not fake-positive).");
      }

      // End with supportive boundary
      steps.push("If you feel unsafe: tell an adult immediately and call local emergency/helpline numbers.");

      // Make it compact and readable
      return "Here are a few steps:\n- " + steps.slice(0,6).join("\n- ");
    }

    function send(){
      const input = document.getElementById("coachInput");
      const text = (input.value || "").trim();
      if(text.length < 2){ toast("Type a message"); return; }

      thread.push({who:"user", text, at: nowISO()});
      // Coach reply
      const reply = coachReply(text);
      thread.push({who:"coach", text: reply, at: nowISO()});

      persist();
      input.value = "";
      renderChat();
      toast("Sent ‚úì");
    }

    on("coachSend","click", send);
    on("coachInput","keydown", (e)=>{
      // Ctrl/Cmd + Enter to send (prevents accidental sends on Enter)
      if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
        e.preventDefault();
        send();
      }
    });

    on("coachExamples","click", ()=>{
      const examples = [
        "I‚Äôm stressed about exams",
        "I can‚Äôt sleep",
        "I feel sad",
        "I can‚Äôt focus",
        "friend issues",
        "anger",
        "I feel insecure / low confidence"
      ];
      const pick = examples[Math.floor(Math.random()*examples.length)];
      document.getElementById("coachInput").value = pick;
      toast("Example added");
    });

    on("coachClear","click", ()=>{
      if(!confirm("Clear this coach chat on this device?")) return;
      const cm = getCoachChat();
      cm[sid] = [];
      saveCoachChat(cm);
      toast("Cleared ‚úì");
      renderStudentCoach();
    });

    renderChat();
  }

  // ============================================================
  // FEATURE 2: EMOTION QUEST (old game restored)
  // - school-life scenarios
  // - choose healthiest response
  // - teaches coping skills
  // - no diagnosis
  // - progress saved locally per student
  // ============================================================
  function renderEmotionQuest(){
    const panel = document.getElementById("studentPanel");
    const sid = session.studentId;

    const QUESTS = [
      {
        id:"ignore_friend",
        title:"Your friend ignores you at school.",
        setup:"You feel hurt and your mind starts guessing worst-case reasons.",
        choices:[
          {text:"Ask calmly later: ‚ÄúHey, are we okay?‚Äù", good:true,
           why:"Healthy: it checks facts, reduces overthinking, and keeps respect."},
          {text:"Post a sad status to get attention.", good:false,
           why:"This may increase drama and doesn‚Äôt solve the real question."},
          {text:"Stop talking forever without asking.", good:false,
           why:"This keeps you stuck in guesses and can break friendships unnecessarily."}
        ],
        skill:"Coping skill: reality-checking + calm communication."
      },
      {
        id:"exam_panic",
        title:"You see a big exam timetable and panic.",
        setup:"Your heart races and you feel like you can‚Äôt handle it.",
        choices:[
          {text:"Pick one tiny task (10 minutes) and start.", good:true,
           why:"Starting breaks panic. Small steps build control."},
          {text:"Scroll your phone for 1 hour to escape.", good:false,
           why:"Avoidance feels good briefly but increases stress later."},
          {text:"Tell yourself ‚ÄúI‚Äôm a failure‚Äù and give up.", good:false,
           why:"Harsh self-talk lowers confidence and doesn‚Äôt help action."}
        ],
        skill:"Coping skill: tiny-start + kind self-talk."
      },
      {
        id:"anger_burst",
        title:"Someone teases you in class.",
        setup:"You feel anger rising and want to shout back.",
        choices:[
          {text:"Pause, 3 breaths, step away for 2 minutes.", good:true,
           why:"This gives your brain time to calm so you can choose a better response."},
          {text:"Shout back immediately to ‚Äòwin‚Äô.", good:false,
           why:"It can escalate conflict and get you in trouble."},
          {text:"Hold it in and pretend you‚Äôre fine.", good:false,
           why:"Bottling anger can build stress. Better to calm, then speak up respectfully."}
        ],
        skill:"Coping skill: pause + cool-down before responding."
      },
      {
        id:"sleep_scroll",
        title:"It‚Äôs late but you keep scrolling.",
        setup:"You know you need sleep, but your brain wants ‚Äòone more‚Äô video.",
        choices:[
          {text:"Put phone away and do a short wind-down routine.", good:true,
           why:"Protects sleep, mood, and memory. Small routines help more than willpower."},
          {text:"Keep scrolling until you‚Äôre exhausted.", good:false,
           why:"Sleep quality drops and tomorrow becomes harder."},
          {text:"Tell yourself you‚Äôll sleep ‚Äòlater‚Äô every night.", good:false,
           why:"Inconsistent sleep builds stress over time."}
        ],
        skill:"Coping skill: boundaries + bedtime routine."
      }
    ];

    const questMap = getQuest();
    const my = questMap[sid] || { idx: 0, streak: 0, lastPlayedDay: null, correct: 0, total: 0 };
    // Keep idx within range
    my.idx = Math.max(0, Math.min(QUESTS.length-1, my.idx));

    const q = QUESTS[my.idx];
    const progressPct = Math.round(((my.idx) / (QUESTS.length)) * 100);

    panel.innerHTML = `
      <div class="stack">
        <div class="note ok">
          <strong>Emotion Quest</strong><br>
          Choose the healthiest response. Learn coping skills through school-life scenarios.
          <div class="help" style="margin-top:8px">This game is for learning coping skills. It doesn‚Äôt diagnose.</div>
        </div>

        <div class="questBox">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div>
              <div class="pillrow" style="gap:8px">
                <span class="pill">üéØ <b>Scenario ${my.idx+1}</b> / ${QUESTS.length}</span>
                <span class="pill">‚úÖ <b>${my.correct}</b> correct</span>
                <span class="pill">üß† streak <b>${my.streak}</b></span>
              </div>
            </div>
            <div class="row">
              <button class="btn" id="questPrev">Prev</button>
              <button class="btn" id="questNext">Next</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="questProgress" aria-label="Progress bar"><div id="questProgFill" style="width:${progressPct}%"></div></div>

          <div class="divider"></div>

          <h3 style="margin:6px 0 6px">${escapeHTML(q.title)}</h3>
          <p class="muted" style="margin:0 0 8px">${escapeHTML(q.setup)}</p>

          <div class="list" id="questChoices"></div>

          <div id="questFeedback" class="note" style="display:none"></div>

          <div class="divider"></div>
          <div class="note warn">
            <strong>Safety note</strong><br>
            If you feel unsafe or think you might harm yourself, stop and tell a trusted adult immediately.
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="questRestart">Restart quest</button>
          <button class="btn" id="questCoachJump">Ask AI wellbeing coach</button>
        </div>
      </div>
    `;

    function persist(){
      const qm = getQuest();
      qm[sid] = my;
      saveQuest(qm);
    }

    function renderChoices(){
      const wrap = document.getElementById("questChoices");
      wrap.innerHTML = q.choices.map((c, i)=>`
        <button class="choiceBtn" id="choice_${i}">
          ${escapeHTML(c.text)}
          <small>${i===0 ? "" : ""}</small>
        </button>
      `).join("");

      q.choices.forEach((c,i)=>{
        on(`choice_${i}`,"click", ()=>{
          // Update stats
          my.total += 1;

          const today = todayKey();
          // streak only counts if played today (prevents farming across days with reloads)
          if(my.lastPlayedDay !== today){
            my.lastPlayedDay = today;
            my.streak = 0;
          }

          const feedback = document.getElementById("questFeedback");
          feedback.style.display = "block";

          if(c.good){
            my.correct += 1;
            my.streak += 1;
            feedback.className = "note ok";
            feedback.innerHTML = `
              <strong>Good choice ‚úÖ</strong><br>
              ${escapeHTML(c.why)}<br>
              <div class="help" style="margin-top:8px">${escapeHTML(q.skill)}</div>
            `;
            toast("Nice ‚úì");
          }else{
            my.streak = 0;
            feedback.className = "note warn";
            feedback.innerHTML = `
              <strong>Not the healthiest ‚ùó</strong><br>
              ${escapeHTML(c.why)}<br>
              <div class="help" style="margin-top:8px">${escapeHTML(q.skill)}</div>
            `;
            toast("Try again");
          }

          persist();

          // Disable choices after one selection to keep it "one decision"
          q.choices.forEach((_,j)=>{
            const b = document.getElementById(`choice_${j}`);
            if(b) b.disabled = true;
          });
        });
      });
    }

    renderChoices();

    on("questPrev","click", ()=>{
      my.idx = Math.max(0, my.idx-1);
      persist();
      renderEmotionQuest();
    });

    on("questNext","click", ()=>{
      my.idx = Math.min(QUESTS.length-1, my.idx+1);
      persist();
      renderEmotionQuest();
    });

    on("questRestart","click", ()=>{
      if(!confirm("Restart Emotion Quest progress on this device?")) return;
      my.idx = 0; my.streak = 0; my.correct = 0; my.total = 0; my.lastPlayedDay = null;
      persist();
      toast("Restarted ‚úì");
      renderEmotionQuest();
    });

    on("questCoachJump","click", ()=>{
      const tab = document.getElementById("sTabCoach");
      if(tab) tab.click();
    });
  }

  // ---------------------------
  // HISTORY
  // ---------------------------
  function renderStudentHistory(){
    const panel = document.getElementById("studentPanel");
    const sid = session.studentId;
    const all = getCheckins().filter(c=>c.studentId===sid).sort((a,b)=> (b.createdAt||"").localeCompare(a.createdAt||""));
    const recent = all.slice(0, 12);

    const ecoMap = getEcoActions();
    const myEco = Array.isArray(ecoMap[sid]) ? ecoMap[sid] : [];
    const ecoToday = myEco.filter(x=>x.day===todayKey()).length;

    const questMap = getQuest();
    const myQ = questMap[sid] || { idx:0, streak:0, correct:0, total:0 };

    panel.innerHTML = `
      <div class="stack">
        <div class="note">
          <strong>My history (on this device)</strong><br>
          This view helps you notice patterns. Nothing here is shared.
        </div>

        <div class="kpi">
          <div class="box"><div class="t">Eco-actions today</div><div class="v">${ecoToday}</div></div>
          <div class="box"><div class="t">Emotion Quest correct</div><div class="v">${myQ.correct || 0}</div></div>
          <div class="box"><div class="t">Check-ins total</div><div class="v">${all.length}</div></div>
        </div>

        ${recent.length ? `
          <div class="list">
            ${recent.map(c => `
              <div class="item">
                <h3>${escapeHTML(fmtDateShort(c.createdAt))} ‚Ä¢ ${escapeHTML(c.mood || "‚Äî")}</h3>
                <p><span class="muted">Sleep:</span> ${c.sleep==null ? "‚Äî" : escapeHTML(c.sleep)}h &nbsp;‚Ä¢&nbsp; <span class="muted">Study:</span> ${c.study==null ? "‚Äî" : escapeHTML(c.study)} min</p>
                ${c.note ? `<div class="divider"></div><p>${escapeHTML(c.note)}</p>` : ""}
              </div>
            `).join("")}
          </div>
        ` : `<div class="note warn">No check-ins yet. Start with a quick check-in ‚Äî even 10 seconds is enough.</div>`}

        <div class="row"><button class="btn danger" id="deleteMyData">Delete my data (this device)</button></div>

        <div class="help">Deleting removes your check-ins, habits, eco-actions, coach chat, and Emotion Quest progress from this browser on this device.</div>
      </div>
    `;

    on("deleteMyData","click", ()=>{
      if(!confirm("Delete your data from this device? This cannot be undone.")) return;

      saveCheckins(getCheckins().filter(c=>c.studentId !== sid));

      const habitsMap = getHabits(); delete habitsMap[sid]; saveHabits(habitsMap);
      const ecoMap2 = getEcoActions(); delete ecoMap2[sid]; saveEcoActions(ecoMap2);

      const coachMap = getCoachChat(); delete coachMap[sid]; saveCoachChat(coachMap);
      const questMap2 = getQuest(); delete questMap2[sid]; saveQuest(questMap2);

      const students = getStudents(); delete students[sid]; saveStudents(students);

      toast("Deleted ‚úì");
      logout();
    });
  }

  // ---------------------------
  // SCHOOL DASHBOARD (no AI)
  // ---------------------------
  function renderSchoolHome(){
    setPage("School dashboard", "Aggregated insights computed locally from students who used this same device. No individual data is shown.");
    mount(`
      <div class="stack">
        <div class="pillrow">
          <span class="pill">üè´ <b>${escapeHTML(settings.schoolName)}</b></span>
          <span class="pill">üîí Local-only aggregation</span>
          <span class="pill">üö´ No individual monitoring</span>
          <span class="pill">ü§ñ No AI in school view</span>
        </div>

        <div class="tabs" role="tablist" aria-label="School tabs">
          <button class="tab active" id="schTabInsights" role="tab" aria-selected="true">Insights</button>
          <button class="tab" id="schTabActions" role="tab" aria-selected="false">Suggested actions</button>
          <button class="tab" id="schTabAdmin" role="tab" aria-selected="false">Admin</button>
        </div>

        <div id="schoolPanel"></div>
      </div>
    `);

    on("schTabInsights","click", ()=>activate("insights"));
    on("schTabActions","click", ()=>activate("actions"));
    on("schTabAdmin","click", ()=>activate("admin"));

    function activate(which){
      ["schTabInsights","schTabActions","schTabAdmin"].forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const match = (id === (which==="insights"?"schTabInsights": which==="actions"?"schTabActions":"schTabAdmin"));
        el.classList.toggle("active", match);
        el.setAttribute("aria-selected", match ? "true":"false");
      });
      if(which==="insights") renderSchoolInsights();
      else if(which==="actions") renderSchoolActions();
      else renderSchoolAdmin();
    }
    activate("insights");
  }

  function computeSchoolAggregation(){
    const checkins = getCheckins();
    const studentsCount = Object.keys(getStudents()).length;

    const now = new Date();
    const last7 = checkins.filter(c=>{
      const d = new Date(c.createdAt || c.day || nowISO());
      const diffDays = (now - d) / (1000*60*60*24);
      return diffDays <= 7.5;
    });

    const moodCounts = {};
    for(const c of last7){
      const m = c.mood || "unknown";
      moodCounts[m] = (moodCounts[m] || 0) + 1;
    }

    const sleepVals = last7.map(c=>c.sleep).filter(v=>typeof v === "number" && !Number.isNaN(v));
    const studyVals = last7.map(c=>c.study).filter(v=>typeof v === "number" && !Number.isNaN(v));
    const avg = (arr)=> arr.length ? (arr.reduce((a,b)=>a+b,0)/arr.length) : null;

    const avgSleep = avg(sleepVals);
    const avgStudy = avg(studyVals);

    const habitsMap = getHabits();
    const t = todayKey();
    let habitMarksToday = 0;
    let habitParticipants = 0;
    for(const sid in habitsMap){
      const h = habitsMap[sid] || {};
      const keys = ["water","move","screenBreak","gratitude","bedtime"];
      const doneAny = keys.some(k => Array.isArray(h[k]) && h[k].includes(t));
      if(doneAny) habitParticipants++;
      habitMarksToday += keys.reduce((acc,k)=> acc + ((Array.isArray(h[k]) && h[k].includes(t)) ? 1 : 0), 0);
    }

    function topMood(){
      const entries = Object.entries(moodCounts).sort((a,b)=>b[1]-a[1]);
      return entries.length ? entries[0][0] : "‚Äî";
    }

    return { studentsCount, last7Count: last7.length, moodCounts, topMood: topMood(), avgSleep, avgStudy, habitMarksToday, habitParticipants };
  }

  function renderSchoolInsights(){
    const panel = document.getElementById("schoolPanel");
    const a = computeSchoolAggregation();

    const avgSleepStr = a.avgSleep == null ? "‚Äî" : (Math.round(a.avgSleep*10)/10).toFixed(1) + "h";
    const avgStudyStr = a.avgStudy == null ? "‚Äî" : Math.round(a.avgStudy) + " min";
    const sampleNote = `Based on ${a.last7Count} check-ins on this device (last 7 days).`;

    panel.innerHTML = `
      <div class="stack">
        <div class="note ok">
          <strong>Local-only school insights</strong><br>
          ${escapeHTML(sampleNote)} No individual student logs, notes, or identities are shown.
        </div>

        <div class="kpi">
          <div class="box"><div class="t">Students on this device</div><div class="v">${a.studentsCount}</div></div>
          <div class="box"><div class="t">Check-ins (last 7 days)</div><div class="v">${a.last7Count}</div></div>
          <div class="box"><div class="t">Most common mood</div><div class="v">${escapeHTML(a.topMood)}</div></div>
        </div>

        <div class="card" style="box-shadow:none; border-radius:18px; background: rgba(255,255,255,.60); border:1px solid rgba(24,55,90,.10)">
          <div class="card-body">
            <div class="stack">
              <div class="item"><h3>Average sleep (last 7 days)</h3><p class="muted">${escapeHTML(avgSleepStr)} <span class="help">(computed locally; ignores blank entries)</span></p></div>
              <div class="item"><h3>Average focused study (last 7 days)</h3><p class="muted">${escapeHTML(avgStudyStr)} <span class="help">(computed locally; ignores blank entries)</span></p></div>
              <div class="item"><h3>Habits marked today (this device)</h3><p class="muted">${a.habitMarksToday} habit marks ‚Ä¢ ${a.habitParticipants} students did at least 1 habit today</p></div>
              <div class="note warn"><strong>Interpretation</strong><br>These insights reflect only the small set of students using this device ‚Äî not the entire school. Use as awareness prompts, not evaluation.</div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function renderSchoolActions(){
    const panel = document.getElementById("schoolPanel");
    const a = computeSchoolAggregation();
    const actions = [];

    actions.push({t:"Wellbeing minute at the start of class", d:"1 minute breathing or grounding before lessons. Normalizes wellbeing habits without singling anyone out."});

    if(a.avgSleep != null && a.avgSleep < 7){
      actions.push({t:"Sleep awareness mini-campaign (1 week)", d:"Share 3 simple tips: consistent wake time, screen down 30 min, wind-down routine. Keep it supportive and optional."});
    }

    if(a.last7Count > 0 && (a.moodCounts.stressed || 0) >= Math.max(2, Math.floor(a.last7Count * 0.35))){
      actions.push({t:"Exam-week stress support", d:"Offer short revision planning tips, calm corners, and teacher reminders: ‚Äòstress is normal ‚Äî small steps help‚Äô."});
    }

    if(a.habitParticipants === 0 && a.studentsCount > 0){
      actions.push({t:"Habit week challenge (opt-in)", d:"Students pick 1 habit for 5 days (water / short walk / gratitude). Celebrate participation, not ‚Äòperformance‚Äô."});
    }

    panel.innerHTML = `
      <div class="stack">
        <div class="note"><strong>Suggested actions (non-clinical)</strong><br>Simple wellbeing activities schools can run without collecting personal student data.</div>
        <div class="list">
          ${actions.map(x=>`<div class="item"><h3>${escapeHTML(x.t)}</h3><p>${escapeHTML(x.d)}</p></div>`).join("")}
        </div>
        <div class="note warn"><strong>Guardrails</strong><br>No individual follow-up based on this dashboard. If a student asks for help directly, follow normal school safeguarding procedures.</div>
      </div>
    `;
  }

  function renderSchoolAdmin(){
    const panel = document.getElementById("schoolPanel");
    panel.innerHTML = `
      <div class="stack">
        <div class="note"><strong>Admin controls (this device only)</strong><br>Useful for demos and pilots. In a real pilot, school devices would be managed by school IT/admin.</div>

        <div class="card" style="box-shadow:none; border-radius:18px; background: rgba(255,255,255,.60); border:1px solid rgba(24,55,90,.10)">
          <div class="card-body">
            <div class="stack">
              <div class="row">
                <div class="field">
                  <label for="schoolName">School name label</label>
                  <input id="schoolName" value="${escapeHTML(settings.schoolName)}" maxlength="50" />
                </div>
              </div>

              <div class="row">
                <button class="btn primary" id="saveSchoolName">Save</button>
                <button class="btn danger" id="wipeDeviceData">Wipe ALL device data</button>
              </div>

              <div class="note warn"><strong>Wipe data</strong><br>Wiping clears student profiles, check-ins, habits, eco-actions, coach chat, and Emotion Quest on this browser on this device only.</div>
            </div>
          </div>
        </div>
      </div>
    `;

    on("saveSchoolName","click", ()=>{
      const v = document.getElementById("schoolName").value.trim();
      settings.schoolName = v || "Your School";
      saveJSON(K.SETTINGS, settings);
      toast("Saved ‚úì");
      renderSchoolHome();
    });

    on("wipeDeviceData","click", ()=>{
      if(!confirm("Wipe ALL MindUrMind data from this device/browser? This cannot be undone.")) return;
      localStorage.removeItem(K.SESSION);
      localStorage.removeItem(K.STUDENTS);
      localStorage.removeItem(K.CHECKINS);
      localStorage.removeItem(K.HABITS);
      localStorage.removeItem(K.ECOACTIONS);
      localStorage.removeItem(K.COACHCHAT);
      localStorage.removeItem(K.QUEST);
      localStorage.removeItem(K.SETTINGS);
      toast("Wiped ‚úì");
      logout();
    });
  }

  // ---------------------------
  // Family Corner (no login)
  // ---------------------------
  function renderFamilyCorner(){
    setPage("Family Corner", "Read-only information for parents/guardians. No parent login is used in this pilot.");
    mount(`
      <div class="stack">
        <div class="note ok">
          <strong>Why no parent login?</strong><br>
          In school pilots, students engage more honestly when they know their private reflections are not visible to anyone. Parents still get guidance and conversation tips here.
        </div>

        <div class="item"><h3>What MindUrMind is</h3><p>A school-based wellbeing awareness and self-learning tool. It helps students build positive habits and emotional literacy.</p></div>
        <div class="item"><h3>What MindUrMind is not</h3><p>Not clinical assessment, diagnosis, therapy, or risk scoring. Not a substitute for professional care.</p></div>
        <div class="item"><h3>Data & privacy (plain language)</h3><p><b>On-device only:</b> student notes and reflections are stored on the device only.<br><b>School insights:</b> aggregated locally from students using the same device.<br>No cloud upload. No central database. No individual monitoring.</p></div>

        <div class="item">
          <h3>Parent conversation tips</h3>
          <p class="muted">Try these simple approaches:</p>
          <ul style="margin:10px 0 0; padding-left:18px; color: rgba(16,33,58,.80); line-height:1.6">
            <li>Ask: ‚ÄúWhat was the hardest part of today?‚Äù (then listen without fixing)</li>
            <li>Normalize feelings: ‚ÄúIt makes sense you feel that way.‚Äù</li>
            <li>Help with one small step: ‚ÄúWhat‚Äôs one tiny thing that would help?‚Äù</li>
            <li>Encourage sleep and routines gently, not as punishment.</li>
            <li>If concerns persist, speak with school counselor or a healthcare professional.</li>
          </ul>
        </div>

        <div class="row"><button class="btn" id="backFromFamily">Back</button></div>
      </div>
    `);
    on("backFromFamily","click", ()=> session ? renderAppHome() : renderSignIn());
  }

  // ---------------------------
  // About & Privacy
  // ---------------------------
  function renderAboutPrivacy(){
    setPage("About & Privacy", "Clear boundaries for schools and students. This is a wellbeing awareness pilot.");
    mount(`
      <div class="stack">
        <div class="note">
          <strong>Positioning statement (pilot-ready)</strong><br>
          MindUrMind is a school-based wellbeing awareness and self-learning initiative designed to help students build positive habits, emotional literacy, and self-reflection skills.<br><br>
          The app does not perform mental health assessments, diagnosis, or therapy.<br>
          Student reflections remain private and stored on the device.<br>
          School insights, when enabled, are aggregated summaries generated locally from participating students on the same device.
        </div>

        <div class="item"><h3>What data is stored?</h3><p><b>On-device only:</b> student check-ins (mood, optional note, sleep & study if entered), habit marks, eco-actions, AI coach chat, Emotion Quest progress.<br><b>Not stored centrally:</b> there is no server and no cloud upload in this pilot prototype.</p></div>
        <div class="item"><h3>Who can see what?</h3><p><b>Student:</b> their own entries on this device.<br><b>School view:</b> aggregated trends computed locally, with no individual entries or notes.<br><b>Parents:</b> no login; Family Corner is information-only.</p></div>
        <div class="item"><h3>Safety note</h3><p>If anyone feels unsafe or in immediate danger, they should contact local emergency services or a trusted adult immediately. The app is not designed for crisis support.</p></div>

        <div class="row"><button class="btn" id="backFromAbout">Back</button></div>
      </div>
    `);
    on("backFromAbout","click", ()=> session ? renderAppHome() : renderSignIn());
  }

  // ---------------------------
  // Boot
  // ---------------------------
  function boot(){
    if(session && session.role){
      logoutBtn.style.display = "inline-flex";
      setRoleBadge(session.role);
      renderAppHome();
    }else{
      renderSignIn();
    }
  }
  boot();

})();
</script>
</body>
</html>
